@using Umbraco.Cms.Web.Common.PublishedModels;
@using Smidge;
@using Smidge.Models;
@using Microsoft.AspNetCore.Hosting;
@using BaseSiteSolution.Infrastructure.Smidge;
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@inject SmidgeHelper SmidgeHelper
@inject IWebHostEnvironment Environment
@inject DynamicCacheBuster CacheBuster
@{
    Layout = null;

    var currentCulture = System.Globalization.CultureInfo.CurrentCulture.Name;

    // Регистрация CSS файлов через SmidgeHelper
    // core.min.css содержит @import для reset.css и style.css, поэтому добавляем только его
    // Если добавить все три файла, код будет дублироваться
    SmidgeHelper.RequiresCss(new CssFile("~/css/core.min.css"));

    // Регистрация JS файлов через SmidgeHelper
    SmidgeHelper.RequiresJs(new JavaScriptFile("~/js/site.js"));
    SmidgeHelper.RequiresJs(new JavaScriptFile("~/js/main.js"));

    // Определение режима отладки на основе окружения
    var debugMode = Environment.EnvironmentName == "Development";

}
<!DOCTYPE html>
<html lang="@currentCulture"
      dir="ltr"
      itemscope
      itemtype="https://schema.org/WebPage"
      prefix="og:http://ogp.me/ns#">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>HTML Template</title>


    <!-- Smidge CSS Files -->
    @{
        var cssOutput = await SmidgeHelper.CssHereAsync(debug: debugMode);
        // Добавляем query string параметр с версией кеш-бастера к URL бандлов Smidge
        // НЕ заменяем версию в расширении файла (.css.v1), так как файл создан с этой версией
        // Вместо этого добавляем ?v={version} или &v={version} для cache busting
        var version = CacheBuster.GetValue();
        var cssHtml = cssOutput.ToString();

        // Добавляем query string параметр v={version} к URL
        // Оставляем оригинальную версию Smidge в расширении файла
        var cssWithVersion = System.Text.RegularExpressions.Regex.Replace(
        cssHtml,
        @"(href=[""'])([^""']*\.css[^""']*)([""'])",
        match =>
        {
            var url = match.Groups[2].Value; // Полный URL включая .v1

            // Проверяем, есть ли уже query string параметры
            if (url.Contains("?"))
            {
                // Если уже есть параметры, добавляем &v={version}
                // Но сначала проверяем, нет ли уже параметра v=
                if (url.Contains("&v=") || url.Contains("?v="))
                {
                    // Заменяем существующий параметр v=
                    var newUrl = System.Text.RegularExpressions.Regex.Replace(
                    url,
                    @"[?&]v=[^&""']*",
                    match2 => match2.Value.StartsWith("?") ? $"?v={version}" : $"&v={version}");
                    return $"{match.Groups[1].Value}{newUrl}{match.Groups[3].Value}";
                }
                else
                {
                    // Добавляем &v={version} к существующим параметрам
                    return $"{match.Groups[1].Value}{url}&v={version}{match.Groups[3].Value}";
                }
            }
            else
            {
                // Нет параметров, добавляем ?v={version}
                return $"{match.Groups[1].Value}{url}?v={version}{match.Groups[3].Value}";
            }
        },
        System.Text.RegularExpressions.RegexOptions.IgnoreCase);
    }
    @Html.Raw(cssWithVersion)

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet" />


</head>

<body>
    <!-- HTML5 -->
    <h1>
        @if (debugMode)
        {
            @Html.Raw("I'm in debag")
            ;
            <p>@debugMode</p>
        }
        else
        {
            @Html.Raw("I'm in Prod")
            ;
        }
    </h1>
    <main class="wrapper">
        @RenderBody()
        <div>
            <a href="https://github.com/harryheman/Modern-HTML-Starter-Template"
               target="_blank"
               rel="noopener noreferrer">
                GitHub page
            </a>
        </div>
    </main>

    <footer>
        <p>
            &copy; 2020. All rights reserved
            <a href="https://github.com/harryheman" target="_blank" rel="noopener">
                Igor Agapov
            </a>
        </p>
        <p>Licensed under MIT</p>
    </footer>

    @* <script src="./src/js/script.js" type="module"></script> *@
    @* <script src="./sw-register.js"></script> *@

    <!-- Smidge JS Files -->
    @{
        var jsOutput = await SmidgeHelper.JsHereAsync(debug: debugMode);
        // Добавляем query string параметр с версией кеш-бастера к URL бандлов Smidge
        // НЕ заменяем версию в расширении файла (.js.v1), так как файл создан с этой версией
        // Вместо этого добавляем ?v={version} или &v={version} для cache busting
        var version2 = CacheBuster.GetValue();
        var jsHtml = jsOutput.ToString();

        // Добавляем query string параметр v={version} к URL
        // Оставляем оригинальную версию Smidge в расширении файла
        var jsWithVersion = System.Text.RegularExpressions.Regex.Replace(
        jsHtml,
        @"(src=[""'])([^""']*\.js[^""']*)([""'])",
        match =>
        {
            var url = match.Groups[2].Value; // Полный URL включая .v1

            // Проверяем, есть ли уже query string параметры
            if (url.Contains("?"))
            {
                // Если уже есть параметры, добавляем &v={version}
                // Но сначала проверяем, нет ли уже параметра v=
                if (url.Contains("&v=") || url.Contains("?v="))
                {
                    // Заменяем существующий параметр v=
                    var newUrl = System.Text.RegularExpressions.Regex.Replace(
                    url,
                    @"[?&]v=[^&""']*",
                    match2 => match2.Value.StartsWith("?") ? $"?v={version2}" : $"&v={version2}");
                    return $"{match.Groups[1].Value}{newUrl}{match.Groups[3].Value}";
                }
                else
                {
                    // Добавляем &v={version} к существующим параметрам
                    return $"{match.Groups[1].Value}{url}&v={version2}{match.Groups[3].Value}";
                }
            }
            else
            {
                // Нет параметров, добавляем ?v={version}
                return $"{match.Groups[1].Value}{url}?v={version2}{match.Groups[3].Value}";
            }
        },
        System.Text.RegularExpressions.RegexOptions.IgnoreCase);
    }
    @Html.Raw(jsWithVersion)
</body>
</html>